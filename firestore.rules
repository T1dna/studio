/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for personal data,
 *   restricts business settings access to developers, and allows open access to customer
 *   and item data. Invoice and payment data is nested under customer for ownership.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles, accessible only to the user themselves.
 * - /business_settings/{businessSettingsId}: Stores global business settings, accessible only to developers.
 * - /customers/{customerId}: Stores customer data, accessible to all authenticated users.
 * - /items/{itemId}: Stores item data, accessible to all authenticated users.
 * - /customers/{customerId}/invoices/{invoiceId}: Stores invoices associated with customers,
 *   accessible to all authenticated users.
 * - /invoices/{invoiceId}/invoice_items/{invoiceItemId}: Stores invoice items associated with invoices,
 *   accessible to all authenticated users.
 * - /customers/{customerId}/payments/{paymentId}: Stores payments associated with customers,
 *   accessible to all authenticated users.
 * - /roles_developer/{userId}: Collection used to store the user IDs of developer roles. Existence of a document grants developer access.
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect privacy.
 * - Business settings are secured and accessible only to developer roles.
 * - Customer and item data are openly accessible to all authenticated users.
 * - Invoice and payment data is nested under customers to simplify ownership and access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access only to the authenticated user for their own user document.
     * @path /users/{userId}
     * @allow (create) - User 'test_user' (auth.uid: 'test_user') can create their own user document.
     * @allow (get, update, delete) - User 'test_user' (auth.uid: 'test_user') can read, update, and delete their own user document.
     * @deny (create) - User 'other_user' (auth.uid: 'other_user') cannot create a user document with ID 'test_user'.
     * @deny (get, update, delete) - User 'other_user' (auth.uid: 'other_user') cannot read, update, or delete the user document with ID 'test_user'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Restricts access to business settings to users with the 'developer' role.
     * @path /business_settings/{businessSettingsId}
     * @allow (get, list) - User 'dev_user' (auth.uid: 'dev_user') with a document in /roles_developer can read business settings.
     * @allow (create, update, delete) - User 'dev_user' (auth.uid: 'dev_user') with a document in /roles_developer can create, update, and delete business settings.
     * @deny (get, list, create, update, delete) - User 'non_dev_user' (auth.uid: 'non_dev_user') without a document in /roles_developer cannot access business settings.
     * @principle Restricts sensitive configuration data to authorized personnel.
     */
    match /business_settings/{businessSettingsId} {
      allow get, list, create, update, delete: if isSignedIn() && request.auth.token.email == 'developer@test.com';
    }

    /**
     * @description Allows any authenticated user to create, read, update, and delete customer data.
     * @path /customers/{customerId}
     * @allow (get, list, create, update, delete) - Any authenticated user can access customer data.
     * @principle Grants open access to customer data for all authenticated users.
     */
    match /customers/{customerId} {
      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to create, read, update, and delete item data.
     * @path /items/{itemId}
     * @allow (get, list, create, update, delete) - Any authenticated user can access item data.
     * @principle Grants open access to item data for all authenticated users.
     */
    match /items/{itemId} {
      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to create, read, update, and delete invoice data under a specific customer.
     * @path /customers/{customerId}/invoices/{invoiceId}
     * @allow (get, list, create, update, delete) - Any authenticated user can access invoice data.
     * @principle Grants open access to invoice data for all authenticated users.
     */
    match /customers/{customerId}/invoices/{invoiceId} {
      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to create, read, update, and delete invoice item data under a specific invoice.
     * @path /invoices/{invoiceId}/invoice_items/{invoiceItemId}
     * @allow (get, list, create, update, delete) - Any authenticated user can access invoice item data.
     * @principle Grants open access to invoice item data for all authenticated users.
     */
    match /invoices/{invoiceId}/invoice_items/{invoiceItemId} {
      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to create, read, update, and delete payment data under a specific customer.
     * @path /customers/{customerId}/payments/{paymentId}
     * @allow get, list, create, update, delete: if isSignedIn();
     * @principle Grants open access to payment data for all authenticated users.
     */
    match /customers/{customerId}/payments/{paymentId} {
      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows developers to create, read, update, and delete documents in the /roles_developer collection.
     * @path /roles_developer/{userId}
     * @allow (get, create, update, delete) - User 'dev_user' (auth.uid: 'dev_user') with a document in /roles_developer can access developer roles data.
     * @principle Restricts modification of developer roles to only those users.
     */
    match /roles_developer/{userId} {
      allow get, create, update, delete: if isOwner(userId) && isDeveloper();
      allow list: if isDeveloper();
    }
    
    /**
     * @description Allows any authenticated user to query the 'invoices' collection group.
     * @path /{path=**}/invoices/{invoiceId}
     * @allow (list) - Any authenticated user can list invoices across all customers.
     * @principle Enables the global invoice list view.
     */
    match /{path=**}/invoices/{invoiceId} {
      allow list: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to query the 'payments' collection group.
     * @path /{path=**}/payments/{paymentId}
     * @allow (list) - Any authenticated user can list payments across all customers.
     * @principle Enables the global payment history view.
     */
    match /{path=**}/payments/{paymentId} {
      allow list: if isSignedIn();
    }


    // --- Helper Functions ---

    /**
     * @description Checks if the user is signed in.
     * @return True if request.auth is not null, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user ID matches the requested user ID.
     * @param {string} userId The user ID to compare against.
     * @return True if the user ID matches the authenticated user's ID, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of an existing document.
     * @param {string} userId The user ID to compare against.
     * @return True if the document exists and the user ID matches the authenticated user's ID, false otherwise.
     */
    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    /**
     * @description Checks if the user has the 'developer' role by verifying their presence in the /roles_developer collection.
     * @return True if the user has a document in the /roles_developer collection, false otherwise.
     */
    function isDeveloper() {
      return exists(/databases/$(database)/documents/roles_developer/$(request.auth.uid));
    }
  }
}
